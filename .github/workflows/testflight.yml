name: Build & Deploy to TestFlight

on:
  push:
    branches:
      - main

env:
  PROJECT: Amigo Gold.xcodeproj
  SCHEME: Amigo Gold Prod
  CONFIGURATION: Release
  ARCHIVE_PATH: build/AmigoGold.xcarchive
  EXPORT_PATH: build/export

jobs:
  build-and-upload:
    name: Build & Upload
    runs-on: macos-14

    steps:
      - name: Checkout sources
        uses: actions/checkout@v4

      - name: Select Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16.0'

      - name: Cache SwiftPM
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Developer/Xcode/DerivedData
            ~/Library/Caches/org.swift.swiftpm
          key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      - name: Create App Store Connect API key
        run: |
          mkdir -p $RUNNER_TEMP/private_keys
          echo "${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}" > "$RUNNER_TEMP/private_keys/AuthKey_${{ secrets.APP_STORE_CONNECT_KEY_ID }}.p8"
        shell: bash

      - name: Clean build directory
        run: rm -rf build && mkdir -p build

      - name: Archive
        run: |
          set -o pipefail
          xcodebuild \
            -project "$PROJECT" \
            -scheme "$SCHEME" \
            -configuration "$CONFIGURATION" \
            -archivePath "$ARCHIVE_PATH" \
            -destination 'generic/platform=iOS' \
            clean archive \
            CODE_SIGN_STYLE=Automatic \
            DEVELOPMENT_TEAM=${{ secrets.APP_STORE_TEAM_ID }}
        shell: bash

      - name: Create export options
        run: |
          cat <<EOF > build/ExportOptions.plist
          {
            "method": "app-store",
            "teamID": "${{ secrets.APP_STORE_TEAM_ID }}",
            "signingStyle": "automatic",
            "uploadBitcode": false,
            "compileBitcode": false
          }
          EOF
        shell: bash

      - name: Export IPA
        run: |
          set -o pipefail
          xcodebuild -exportArchive \
            -archivePath "$ARCHIVE_PATH" \
            -exportOptionsPlist build/ExportOptions.plist \
            -exportPath "$EXPORT_PATH" \
            -allowProvisioningUpdates \
            -authenticationKeyPath "$RUNNER_TEMP/private_keys/AuthKey_${{ secrets.APP_STORE_CONNECT_KEY_ID }}.p8" \
            -authenticationKeyID "${{ secrets.APP_STORE_CONNECT_KEY_ID }}" \
            -authenticationKeyIssuerID "${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}"
        shell: bash

      - name: Upload to TestFlight
        run: |
          xcrun altool --upload-app \
            -f "$EXPORT_PATH/Amigo Gold.ipa" \
            -t ios \
            --apiKey "${{ secrets.APP_STORE_CONNECT_KEY_ID }}" \
            --apiIssuer "${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}"
        shell: bash
